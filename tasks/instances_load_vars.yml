---

- name: clear aws_ec2_instances from earlier includes
  include_vars: instances_empty.yml

- name: read variables for EC2 instance function
  include_vars: '{{ _aws_ec2_function_file }}'

- name: add instance to configured list
  set_fact:
    _aws_ec2_configured_instances: >-
      {{ _aws_ec2_configured_instances
         | default([])
         | union([instance]) }}
  with_items: '{{ aws_ec2_instances }}'
  loop_control:
    loop_var: instance

- name: add instance to target list if function and environment match
  set_fact:
    _aws_ec2_target_instances: >-
      {{ _aws_ec2_target_instances
         | default([])
         | union([instance]) }}
  with_items: '{{ aws_ec2_instances }}'
  when: >
    ( instance.function in _aws_ec2_target_functions or
      _aws_ec2_target_functions == [""] ) and
    ( instance.environment in _aws_ec2_target_environments or
      _aws_ec2_target_environments == [""] )
  loop_control:
    loop_var: instance
