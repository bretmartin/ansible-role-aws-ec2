---

- name: read variables
  include_vars:
    file: '{{ _aws_ec2_vars_file }}'
    name: _aws_ec2_vars

- name: add instances to configured list
  set_fact:
    _aws_ec2_configured_instances: >-
      {{ _aws_ec2_configured_instances
         | default([])
         | union([instance]) }}
  with_items: '{{ _aws_ec2_vars["aws_ec2_instances"] }}'
  when: >
    'aws_ec2_instances' in _aws_ec2_vars
  loop_control:
    loop_var: instance

- name: add instance to target list if function and environment match
  set_fact:
    _aws_ec2_target_instances: >-
      {{ _aws_ec2_target_instances
         | default([])
         | union([instance]) }}
  with_items: '{{ _aws_ec2_vars["aws_ec2_instances"] }}'
  when: >
    'aws_ec2_instances' in _aws_ec2_vars and
    ( instance.function in _aws_ec2_target_functions or
      _aws_ec2_target_functions == [""] ) and
    ( instance.environment in _aws_ec2_target_environments or
      _aws_ec2_target_environments == [""] )
  loop_control:
    loop_var: instance
